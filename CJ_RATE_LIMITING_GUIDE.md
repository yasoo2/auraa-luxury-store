# ๐ก๏ธ ุฏููู ูุธุงู ุงูุญูุงูุฉ ูู ุฎุทุฃ 429 - CJ Dropshipping

## ๐ฏ ูุธุฑุฉ ุนุงูุฉ

ุชู ุชุทุจูู ูุธุงู ุญูุงูุฉ ูุชูุฏู ูู ุฎุทุฃ **429: too_many_requests** ูู CJ Dropshipping API ุนุจุฑ **3 ุทุจูุงุช**:

1. โ **Rate Limiter** - ุญุฏ ุฃูุตู ููุทูุจุงุช ูู ุงูุซุงููุฉ
2. โ **Retry + Backoff** - ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุงูุชููุงุฆูุฉ ูุน ุชุฃุฎูุฑ ุชุตุงุนุฏู
3. โ **Batching + Concurrency** - ุงุณุชูุฑุงุฏ ุนูู ุฏูุนุงุช ูุน ุญุฏ ุฃูุตู ููุชูุงุฒู

---

## ๐ฆ ุงููููุงุช ุงูุฌุฏูุฏุฉ

### 1. `/backend/services/cj_client.py`
**ุงููุตู:** Client ูุฑูุฒู ูุฌููุน ุทูุจุงุช CJ API

**ุงููููุฒุงุช:**
- โ Rate Limiting: ุญุฏ ุฃูุตู 2 ุทูุจ/ุซุงููุฉ (ูุงุจู ููุชุนุฏูู)
- โ Retry ูุน Exponential Backoff (ุญุชู 5 ูุญุงููุงุช)
- โ Semaphore ููุชุญูู ูู ุงูุชูุงุฒู (ุญุฏ ุฃูุตู 3 ุทูุจุงุช ูุชุฒุงููุฉ)
- โ ููุฌููุฌ ุชูุตููู ููู ุทูุจ
- โ ูุนุงูุฌุฉ ุฐููุฉ ููุฃุฎุทุงุก (401/403 ูุง ุชูุนุงุฏุ 429/5xx ุชูุนุงุฏ)

**ุงููุธุงุฆู:**
```python
await list_products(page_num, page_size, keyword)  # ุฌูุจ ูุงุฆูุฉ ุงูููุชุฌุงุช
await get_product_details(pid)                     # ุชูุงุตูู ููุชุฌ ูุงุญุฏ
await authenticate()                               # ุชูุซูู
```

---

### 2. `/backend/services/import_service.py`
**ุงููุตู:** ุฎุฏูุฉ ุงูุงุณุชูุฑุงุฏ ุนูู ุฏูุนุงุช

**ุงููููุฒุงุช:**
- โ ุงุณุชูุฑุงุฏ 1-1000 ููุชุฌ ุนูู ุฏูุนุงุช (50 ููุชุฌ/ุฏูุนุฉ)
- โ ุฑุงุญุฉ 2 ุซุงููุฉ ุจูู ูู ุฏูุนุฉ
- โ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ููู ุฏูุนุฉ ุนูู ุญุฏุฉ
- โ ุชูุฑูุฑ ููุตู ุจุงููุฌุงุญ ูุงููุดู

**ุงููุธุงุฆู:**
```python
await bulk_import_products(total_count, keyword)   # ุงุณุชูุฑุงุฏ ุนูู ุฏูุนุงุช
await fetch_product_details_batch(product_ids)     # ุฌูุจ ุชูุงุตูู ุจุงูุฏูุนุงุช
```

---

### 3. `/backend/routes/cj_admin.py`
**ุงููุตู:** ูุณุงุฑุงุช ุฅุฏุงุฑูุฉ ููุงุฎุชุจุงุฑ ูุงูุงุณุชูุฑุงุฏ

**ุงููุณุงุฑุงุช:**
- `GET /admin/cj/ping` - ูุญุต ุณุฑูุน ููุงุชุตุงู
- `GET /admin/cj/test-auth` - ุงุฎุชุจุงุฑ ุงูุชูุซูู
- `POST /admin/cj/import/bulk` - ุงุณุชูุฑุงุฏ ุนูู ุฏูุนุงุช
- `GET /admin/cj/products/list` - ุฌูุจ ูุงุฆูุฉ (ูุนุงููุฉ)

---

## ๐ง ุงูุฅุนุฏุงุฏุงุช

### ูู `/backend/.env`:

```env
# CJ Dropshipping Settings
CJ_DROPSHIP_EMAIL="Info.auraaluxury@gmail.com"
CJ_DROPSHIP_API_KEY="942ad21128534fba953d489b4d6688ee"

# Rate Limiting Settings (NEW)
CJ_BASE="https://developers.cjdropshipping.com/api2.0"
CJ_RPS=2                # Requests Per Second
CJ_MAX_CONCURRENCY=3    # Max concurrent requests
```

### ุชุนุฏูู ุงูุฅุนุฏุงุฏุงุช:

**ุฒูุงุฏุฉ ุงูุณุฑุนุฉ (ุจุญุฐุฑ!):**
```env
CJ_RPS=5                # 5 ุทูุจุงุช/ุซุงููุฉ
CJ_MAX_CONCURRENCY=5    # 5 ุทูุจุงุช ูุชุฒุงููุฉ
```

**ููุฃูุงู ุงูุฃูุตู:**
```env
CJ_RPS=1                # ุทูุจ ูุงุญุฏ/ุซุงููุฉ ููุท
CJ_MAX_CONCURRENCY=1    # ุทูุจ ูุงุญุฏ ูู ูู ูุฑุฉ
```

---

## ๐ ููููุฉ ุงูุงุณุชุฎุฏุงู

### 1. ุงุฎุชุจุงุฑ ุงูุงุชุตุงู

**ูู ุงููุชุตูุญ ุฃู Postman:**
```
GET https://luxury-import-sys.preview.emergentagent.com/admin/cj/ping
```

**ุงูุงุณุชุฌุงุจุฉ ุงููุชููุนุฉ:**
```json
{
  "ok": true,
  "message": "โ CJ API is reachable",
  "data": {...}
}
```

---

### 2. ุงุฎุชุจุงุฑ ุงูุชูุซูู

```
GET https://luxury-import-sys.preview.emergentagent.com/admin/cj/test-auth
```

**ุงูุงุณุชุฌุงุจุฉ ุงููุชููุนุฉ:**
```json
{
  "ok": true,
  "message": "โ Authentication successful",
  "data": {...}
}
```

---

### 3. ุงุณุชูุฑุงุฏ ููุชุฌุงุช

**ูู Postman:**
```
POST https://luxury-import-sys.preview.emergentagent.com/admin/cj/import/bulk

Body (JSON):
{
  "count": 50,
  "keyword": "luxury jewelry"
}
```

**ุงูุงุณุชุฌุงุจุฉ:**
```json
{
  "ok": true,
  "message": "โ Import complete: 50/50 products",
  "results": {
    "total_requested": 50,
    "total_fetched": 50,
    "ok": 50,
    "failed": 0,
    "batches": [
      {
        "batch": 1,
        "page": 1,
        "size": 50,
        "status": "success"
      }
    ],
    "products": [...]
  }
}
```

---

### 4. ูู ุตูุญุฉ Quick Import

ุงูุตูุญุฉ ุงูุขู ุชุณุชุฎุฏู ุงููุธุงู ุงูุฌุฏูุฏ ุชููุงุฆูุงู! ููุท:

1. ุฃุฏุฎู ุงูุนุฏุฏ (1-1000)
2. ุงุถุบุท ๐ด ุงุณุชูุฑุงุฏ ุงูุขู
3. ุงููุธุงู ูุณุชูุฑุฏ ุนูู ุฏูุนุงุช ูุน rate limiting ุชููุงุฆู

---

## ๐ ููู ูุนูู ุงููุธุงูุ

### ุทูุจ ูุงุญุฏ:

```
Frontend โ Backend โ Rate Limiter (2 req/sec) โ Semaphore (max 3) โ CJ API
                  โ
              429 Error?
                  โ
         Retry with Backoff (2s, 4s, 8s, 16s, 30s)
                  โ
            Success โ
```

### ุงุณุชูุฑุงุฏ 100 ููุชุฌ:

```
100 ููุชุฌ
  โ
ูุณูููุง ุฅูู ุฏูุนุงุช (50 ููุชุฌ ร 2)
  โ
Batch 1: 50 ููุชุฌ
  โโโ Rate Limited (2 req/sec)
  โโโ Max 3 concurrent
  โโโ Retry on 429/5xx
  โโโ โ Success
  โ
Sleep 2 seconds
  โ
Batch 2: 50 ููุชุฌ
  โโโ Rate Limited
  โโโ Max 3 concurrent
  โโโ Retry on 429/5xx
  โโโ โ Success
```

---

## ๐ ูุฑุงูุจุฉ ุงูุฃุฏุงุก

### ูู Logs:

```bash
# ูู Render ุฃู Local
tail -f /var/log/supervisor/backend.err.log | grep "CJ"
```

**ูุง ุณุชุฑุงู:**
```
๐ CJ API Request: POST /v1/product/list
โ CJ API Success: POST /v1/product/list
๐ฆ Batch 1/2: Fetching page 1
โ Batch 1 success: 50 products (50/100)
๐ด Sleeping 2s before next batch...
๐ฆ Batch 2/2: Fetching page 2
โ Batch 2 success: 50 products (100/100)
โ Bulk import complete: 100/100 products fetched
```

**ูู ุญุงูุฉ Retry:**
```
โ๏ธ CJ API 429 - will retry: Rate limit exceeded
โณ CJ API retry attempt 1 after error
[Sleep 2 seconds...]
๐ CJ API Request: POST /v1/product/list (retry)
โ CJ API Success: POST /v1/product/list
```

---

## โ๏ธ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ูุดููุฉ: "CJ_DROPSHIP_API_KEY not configured"

**ุงูุญู:**
1. ุชุฃูุฏ ูู ูุฌูุฏ ุงูููุชุงุญ ูู `/backend/.env`
2. ุฃุนุฏ ุชุดุบูู Backend: `sudo supervisorctl restart backend`

---

### ูุดููุฉ: ูุง ุฒูุช ุฃุญุตู ุนูู 429

**ุงูุณุจุจ ุงููุญุชูู:** ุงูุฅุนุฏุงุฏุงุช ุนุงููุฉ ุฌุฏุงู

**ุงูุญู:**
```env
# ุฎููุถ ุงูููู ูู .env
CJ_RPS=1
CJ_MAX_CONCURRENCY=1
```

ุฃุนุฏ ุงูุชุดุบูู ูุฌุฑูุจ ูุฑุฉ ุฃุฎุฑู.

---

### ูุดููุฉ: ุงูุงุณุชูุฑุงุฏ ุจุทูุก ุฌุฏุงู

**ุงูุณุจุจ:** ุงูุฅุนุฏุงุฏุงุช ูุญุงูุธุฉ ููุบุงูุฉ

**ุงูุญู:**
```env
# ุฒูุฏ ุงูููู ุชุฏุฑูุฌูุงู
CJ_RPS=3
CJ_MAX_CONCURRENCY=5
```

**ููุงุญุธุฉ:** ุฑุงูุจ ุงูู Logs! ุฅุฐุง ุธูุฑุช 429ุ ุฎููุถ ุงูููู.

---

### ูุดููุฉ: "Authentication failed"

**ุงูุญู:**
1. ุชุฃูุฏ ูู CJ API Key ุตุญูุญ
2. ุฌุฑูุจ endpoint ุงูุชูุซูู: `GET /admin/cj/test-auth`
3. ุฅุฐุง ูุดูุ ุงุญุตู ุนูู API Key ุฌุฏูุฏ ูู CJ Dashboard

---

## ๐ฏ ุฃูุถู ุงูููุงุฑุณุงุช

### 1. ุงุจุฏุฃ ุจุฅุนุฏุงุฏุงุช ูุญุงูุธุฉ
```env
CJ_RPS=2
CJ_MAX_CONCURRENCY=3
```

### 2. ุฑุงูุจ ุงูุฃุฏุงุก
- ุดุงูุฏ ุงูู Logs
- ูุงุญุธ ุฅุฐุง ุธูุฑุช 429
- ุฅุฐุง ูุงู ุณูุณุงูุ ุฒูุฏ ุงูููู ุชุฏุฑูุฌูุงู

### 3. ูุง ุชุณุชูุฑุฏ ุฃูุซุฑ ูู 200-300 ููุชุฌ ูู ุทูุจ ูุงุญุฏ
- ุงูุฃูุถู: 50-100 ููุชุฌ/ุทูุจ
- ุงุณุชุฎุฏู ุทูุจุงุช ูุชุนุฏุฏุฉ ููุฃุนุฏุงุฏ ุงููุจูุฑุฉ

### 4. ุงูููุช ุงููุซุงูู ููุงุณุชูุฑุงุฏ
- ุชุฌูุจ ุณุงุนุงุช ุงูุฐุฑูุฉ (ุฅุฐุง ูุงูุช CJ ูุฏููุง ุฐุฑูุฉ ูุนููุฉ)
- ุงุณุชูุฑุฏ ูู ุฃููุงุช ูุงุฏุฆุฉ

---

## ๐ ุงูููุงุณุงุช

### ูุน ุงูุฅุนุฏุงุฏุงุช ุงูุงูุชุฑุงุถูุฉ (RPS=2, Concurrency=3):

| ุงูุนุฏุฏ | ุงูููุช ุงููุชููุน | ุงูุฏูุนุงุช |
|-------|---------------|---------|
| 50    | ~30 ุซุงููุฉ    | 1       |
| 100   | ~1 ุฏูููุฉ     | 2       |
| 200   | ~2 ุฏูููุฉ     | 4       |
| 500   | ~5 ุฏูุงุฆู     | 10      |
| 1000  | ~10 ุฏูุงุฆู    | 20      |

**ููุงุญุธุฉ:** ุงูุฃููุงุช ุชูุฑูุจูุฉ ูุชุนุชูุฏ ุนูู ุงุณุชุฌุงุจุฉ CJ API

---

## ๐ ุงูุฃูุงู

### ุงูุญูุงูุฉ ูู:
- โ **Rate Limiting Abuse** - ุญุฏ ุฃูุตู ููุทูุจุงุช
- โ **DDoS ุนูู CJ API** - ุชุญูู ูู ุงูุชูุงุฒู
- โ **Retry Storms** - backoff ุชุตุงุนุฏู ุฐูู
- โ **Invalid Credentials** - ูุนุงูุฌุฉ 401/403 ููุฑุงู
- โ **Network Issues** - retry ุนูู ุฃุฎุทุงุก ุงูุดุจูุฉ

---

## ๐ ุงูุฎูุงุตุฉ

**ุงููุธุงู ุงูุขู:**
- โ ูุญูู ูู 429 ุจู 3 ุทุจูุงุช
- โ ูุนูุฏ ุงููุญุงููุฉ ุชููุงุฆูุงู
- โ ูุณุชูุฑุฏ ุนูู ุฏูุนุงุช
- โ ููุฌููุฌ ุชูุตููู
- โ ูุงุจู ููุชุฎุตูุต

**ุงููุทููุจ ููู:**
1. ุชุญุฏูุซ CJ API Key (ุฅุฐุง ูุฒู ุงูุฃูุฑ)
2. ุงุฎุชุจุงุฑ endpoint `/admin/cj/ping`
3. ุงุณุชูุฑุงุฏ ููุชุฌุงุช ุชุฌุฑูุจูุฉ (10-50 ููุชุฌ)
4. ูุฑุงูุจุฉ ุงูุฃุฏุงุก
5. ุชุนุฏูู ุงูุฅุนุฏุงุฏุงุช ุญุณุจ ุงูุญุงุฌุฉ

๐ **ุฌุงูุฒ ููุงุณุชูุฑุงุฏ ุงูุขูู ูุงูุณุฑูุน!**

---

**ุขุฎุฑ ุชุญุฏูุซ:** 22 ุฃูุชูุจุฑ 2025  
**ุงูุฅุตุฏุงุฑ:** 1.0
